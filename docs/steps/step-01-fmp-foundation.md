# Step 1: Data Provider Foundation (FMP 안정화)

## 목표
FMP 기반 데이터 수집/조회가 기본 경로가 되도록 안정화하고, 유지보수 기준을 명확히 한다.

## 현재 상태
- FMP 마이그레이션은 완료된 것으로 간주한다.
- 잔여 레거시 호출이 있다면 문서화 후 정리 대상에 포함한다.

## 결정사항
- 기본 데이터 소스: FMP 단일 소스
- 예외/폴백 사용 시 반드시 근거와 범위를 문서에 남긴다.
- 데이터 저장은 SQLite 단일 소스로 전환한다 (상세: Step 2).

## 구현 가이드 (미완 항목 상세)
### 1) API 키/환경 변수 관리
- `.env` 필수 키: `FMP_API_KEY`, 선택 키: `FMP_BASE_URL`, `FMP_MAX_RETRIES`, `FMP_BACKOFF_BASE`, `FMP_BACKOFF_MAX`.
- 키 유효성 체크: 현재는 경고만 출력하며 파이프라인은 계속 진행됩니다.
- 로그에는 키 일부 마스킹, 원문 출력 금지.
- 키 교체/만료 테스트 절차 문서화(운영 체크리스트에 포함).

### 2) 레이트리밋/재시도 정책 고정
- `utils/fmp_client.py`의 백오프/재시도 로직을 표준으로 고정.
- 429/5xx 발생 시 지수 백오프 + jitter 적용, `Retry-After` 헤더 존재 시 우선 반영(추가 구현).
- 스크리너 병렬 실행 시 동시 호출 수 제한(`SMART_MONEY_WORKERS`) 기본값 명시.
- 호출량 기록: 모듈별 API usage count를 로그/메타에 저장(스크리너는 이미 일부 기록됨).

### 3) 심볼 정규화/맵핑 규칙
- `utils/symbols.py`에 특수 심볼 규칙 명시(예: `BRK-B -> BRK.B`, `BF-B -> BF.B`).
- 심볼 정규화는 **모든 API 호출 전에 단일 함수**로 처리.
- 심볼 변환 규칙 변경 시 테스트 케이스 추가(심볼 입력/출력 비교).

### 4) 데이터 품질 가드레일
- FMP 응답 스키마가 비어있을 경우 빈 결과로 처리하고 경고 로그 남김.
- 가격 데이터: 날짜 파싱 실패 행 드롭 카운트 로깅(이미 일부 구현됨, 누락 구간 확인 포함).
- 파이프라인 갭 로그: `logs/pipeline_gaps.jsonl`에 기록 규칙 유지.

### 5) 테스트/모킹 표준
- `tests/conftest.py`의 `mock_fmp_client`를 표준 모킹으로 유지.
- 최소 엔드포인트 스모크 테스트에서 FMP 호출이 발생하지 않도록 모킹 강제.
- 429/5xx 재시도 경로를 단위테스트로 검증(재시도 횟수/지연 확인).

## 유지보수 체크리스트
- [ ] FMP API 키/레이트리밋 정책 문서 최신화
- [ ] 429/5xx 재시도 정책 점검 (백오프/타임아웃)
- [ ] 심볼 매핑(지수/원자재/크립토) 최신화
- [ ] 레거시 데이터 소스 호출 잔여 여부 점검 및 제거
- [ ] 테스트에서 FMP mock 안정화

## 완료 기준
- FMP 기반 호출이 모든 기본 경로에서 정상 동작
- 레거시 소스는 제거되었거나 예외 사유가 문서화됨
