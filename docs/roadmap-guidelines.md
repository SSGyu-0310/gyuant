# Gyunat Roadmap Guidelines (Local-First, FMP + Value Strategy)

이 문서는 현재 코드베이스의 상태를 기준으로, 단기/장기 목표를 안전하게 달성하기 위한 방향성과 체크리스트를 정리합니다. 초고성능 코딩 에이전트를 사용할 수 있다는 전제를 둡니다.

## Step 문서 인덱스 (에이전트용 상세 가이드)
- Step 1: `docs/steps/step-01-fmp-foundation.md`
- Step 2: `docs/steps/step-02-data-migration.md`
- Step 3: `docs/steps/step-03-backtest-data-model.md`
- Step 4: `docs/steps/step-04-backtest-engine.md`
- Step 5: `docs/steps/step-05-alpha-generalization.md`

## 현재 프로그램의 상태 요약
- 데이터 수집이 FMP 중심이며, `us_market/` 파이프라인에서 CSV/JSON 결과물을 생성하고 Flask API가 이를 읽는 구조입니다.
- 실시간/단기 가격 조회는 `flask_app.py`에서 FMP를 직접 호출합니다.
- 파이프라인은 `us_market/update_all.py` 기준으로 단계별 스크립트가 정리되어 있습니다.
- 테스트는 일부 엔드포인트와 파일 계약(contract) 중심이며 FMP mock에 의존합니다.

## 장점
- 데이터 파이프라인이 단계별 스크립트로 분리되어 있어 교체 지점이 명확합니다.
- 산출물(예: `us_daily_prices.csv`, `smart_money_picks_v2.csv`) 중심으로 API가 작동하여 교체 범위를 통제하기 쉽습니다.
- 로컬 실행 기준으로 운영 복잡도가 낮고 디버깅이 빠릅니다.

## 단점/리스크
- FMP 레이트리밋/커버리지 제약이 있으며, 데이터 스키마가 암묵적입니다.
- 과거 시점 재현(백테스트)에 필요한 point-in-time 데이터 구조가 부족합니다.
- 심볼/시장(지수, FX, crypto, commodities) 매핑이 Yahoo 기준에 묶여 있습니다.

## 단기 목표에 맞는 실행 방향
### 1) FMP로 마이그레이션
- 단일 FMP 클라이언트 계층을 만들고, 모든 수집 로직이 이를 통과하도록 만드세요.
- 기존 산출물의 스키마를 유지해 후속 로직 변경을 최소화하세요.
- 데이터 소스 토글은 유지하되, 기본값은 FMP로 운영합니다.

### 2) 백테스팅 추가 (가치투자, 장기 보유)
목표는 "과거 시점 기준으로 매수 -> 장기 보유 -> 지표 평가"입니다. 복잡한 로직보다 데이터 정합성이 핵심입니다.
- Point-in-time 데이터: 백테스트는 과거 기준으로 데이터가 존재했음을 보장해야 합니다.
- Look-ahead bias 방지: 시점 이후의 지표가 섞이지 않도록, 모든 지표는 평가일 기준 이전 데이터만 사용.
- Survivorship bias 방지: 지금 살아남은 종목만 쓰지 말고, 당시 존재했던 종목을 포함해야 합니다.
- 시각화는 단순히 가격 차트 + 누적 수익률 + 샤프/MDD 정도로 시작하세요.

## 장기 목표에 맞는 실행 방향
### 범용적 알파로 확장
현재의 고정된 알파는 "파라미터/지표 확장"으로 일반화하는 방향이 안전합니다.
- 알파를 함수형으로 분리하고 입력 파라미터를 명시적으로 정의합니다.
- 지표 추가 시에는 데이터 스키마와 계산 타이밍(시점)을 먼저 정의합니다.
- 베이스라인 알파를 보존하고, 새로운 알파는 "추가 옵션"으로만 작동하게 만듭니다.

## 앞으로 작업할 때 신경써야 할 것
### 데이터 일관성
- CSV/JSON 산출물의 스키마를 문서화하고 버전 관리하세요.
- 데이터 소스가 바뀌어도 산출물이 같아야 파이프라인이 안정됩니다.

### 시간/시점 처리
- 백테스트용 데이터는 "날짜 기준"이 명확해야 합니다.
- 실시간/백테스트 데이터를 분리한 저장 구조가 필요합니다.
- 모든 계산에 기준 시점을 포함시키세요 (예: `as_of`).

### 성능/레이트리밋
- FMP API는 429가 발생할 수 있으니 백오프 및 캐시를 기본으로 두세요.
- 다건 호출이 필요하면 batch endpoint를 우선 활용하세요.

### 테스트 전략
- 테스트 mock을 FMP 기준으로 유지합니다.
- 백테스트 결과는 숫자/범위 기반 스냅샷 테스트가 유용합니다.
- 산출물 계약 검증 테스트를 강화하세요 (파일 존재, 스키마, 최신성).

## 계획 제안 (로컬 실행 기준)
1. FMP 클라이언트 추가 + 주요 엔드포인트 교체.
2. `us_daily_prices.csv` 생성 방식을 FMP 기반으로 안정화.
3. 백테스트용 데이터 구조 설계 (date-indexed 가격 + 지표).
4. 단순 백테스트(1~3종목)로 시각화 + 샤프/MDD.
5. 알파 파라미터화 및 지표 추가.

## 유의할 점
- 데이터 소스가 바뀌면 숫자 결과가 달라질 수 있으니, 목표 성능보다 일관성을 먼저 확보하세요.
- 백테스트는 "재현 가능한 과거"가 핵심입니다. 이 구조가 잡히면 지표 확장은 쉬워집니다.
- 범용성을 위해서는 "데이터, 알파, 평가" 레이어를 분리하는 게 중요합니다.

## 초심자에게의 조언 (하지만 코딩 에이전트가 있는 전제)
- 로직보다 데이터 구조부터 고정하세요. 구조가 잡히면 코딩은 쉽게 자동화됩니다.
- 최소 기능으로 빠르게 결과를 확인한 뒤, 데이터를 늘리고 지표를 확장하세요.
- 테스트는 스냅샷/계약 중심으로 시작하면 부담이 적습니다.

## 참고
FMP 마이그레이션 세부 가이드는 `docs/fmp-migration-guide.md`를 참고하세요.
