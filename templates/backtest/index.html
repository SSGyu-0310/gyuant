{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Backtest Dashboard</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Run New Backtest</h2>
            <form id="backtestForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Strategy</label>
                    <select name="strategy_name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        <option value="SmartMoneyTopN">Smart Money Top N</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" name="start_date" value="2023-01-01"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" name="end_date" value="2023-12-31"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Initial Capital</label>
                    <input type="number" name="initial_capital" value="100000"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                    Run Backtest
                </button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Recent Runs</h2>
            <div id="runsList" class="space-y-2 max-h-96 overflow-y-auto">
                <p class="text-gray-500">Loading...</p>
            </div>
        </div>
    </div>

    <div id="resultsSection" class="hidden">
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Backtest Results</h2>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Total Return</div>
                    <div id="metricTotalReturn" class="text-2xl font-bold">-</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">CAGR</div>
                    <div id="metricCAGR" class="text-2xl font-bold">-</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Sharpe Ratio</div>
                    <div id="metricSharpe" class="text-2xl font-bold">-</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Max Drawdown</div>
                    <div id="metricMaxDD" class="text-2xl font-bold text-red-600">-</div>
                </div>
                <div class="bg-gray-50 p-4 rounded">
                    <div class="text-sm text-gray-600">Volatility</div>
                    <div id="metricVolatility" class="text-2xl font-bold">-</div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Equity Curve</h2>
            <canvas id="equityChart" height="100"></canvas>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Trades</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ticker</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Side</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shares</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fee</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTable" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    let currentRunId = null;
    let equityChart = null;

    function loadRuns() {
        fetch('/api/backtest/runs')
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('runsList');
                if (!data.runs || data.runs.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">No runs yet.</p>';
                    return;
                }
                list.innerHTML = data.runs.map(run => `
                <div class="p-3 bg-gray-50 rounded border border-gray-200 cursor-pointer hover:bg-gray-100"
                     onclick="selectRun('${run.run_id}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium">${run.strategy_name}</div>
                            <div class="text-sm text-gray-600">${run.start_date} ~ ${run.end_date}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-semibold ${getStatusColor(run.status)}">${run.status}</div>
                            <div class="text-xs text-gray-500">${run.created_at ? new Date(run.created_at).toLocaleDateString() : ''}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            });
    }

    function getStatusColor(status) {
        switch (status) {
            case 'finished': return 'text-green-600';
            case 'failed': return 'text-red-600 font-bold';
            case 'running': return 'text-blue-600';
            default: return 'text-yellow-600';
        }
    }

    function selectRun(runId) {
        currentRunId = runId;
        fetchRun(runId).then(data => {
            if (!data || data.error) {
                alert('Error: ' + (data?.error || 'Unknown error'));
                return;
            }
            displayResults(data);
            if (data.status === 'running' || data.status === 'queued') {
                setTimeout(() => pollRun(runId), 2000);
            }
        });
    }

    function fetchRun(runId) {
        return fetch(`/api/backtest/runs/${runId}`).then(r => r.json());
    }

    function pollRun(runId) {
        fetchRun(runId)
            .then(data => {
                if (!data) {
                    return;
                }

                displayResults(data);

                if (data.status === 'running' || data.status === 'queued') {
                    setTimeout(() => pollRun(runId), 2000);
                } else {
                    loadRuns();
                }
            });
    }

    function toFiniteNumber(value) {
        if (value === null || value === undefined) {
            return NaN;
        }
        const numeric = typeof value === 'number' ? value : Number(value);
        return Number.isFinite(numeric) ? numeric : NaN;
    }

    function formatNumber(value, decimals = 2) {
        const numeric = toFiniteNumber(value);
        return Number.isFinite(numeric) ? numeric.toFixed(decimals) : '-';
    }

    function formatPercent(value) {
        const numeric = toFiniteNumber(value);
        return Number.isFinite(numeric) ? `${(numeric * 100).toFixed(2)}%` : '-';
    }

    function displayResults(data) {
        if (data.status === 'failed') {
            const errorMsg = data.error_message || 'Unknown error occurred';
            document.getElementById('resultsSection').innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            <strong>Backtest Failed:</strong> ${errorMsg}
                        </p>
                    </div>
                </div>
            </div>
        `;
            document.getElementById('resultsSection').classList.remove('hidden');
            return;
        }

        // Reset results section content if it was previously showing error
        if (!document.getElementById('metricTotalReturn')) {
            // Simple reload of the page or re-render initial structure would be better, 
            // but for now let's just reload the page if structure is broken
            // or we can manually reconstruct. 
            // Simplest: just hide it and let user click again or refresh.
            // But to be robust, let's just reload content.
            location.reload();
            return;
        }

        document.getElementById('resultsSection').classList.remove('hidden');

        const metrics = data.metrics || {};
        // Use || 0 to default to 0 if null/undefined, ensuring we display 0.00% instead of -
        // Use innerHTML because globally loaded formatPercent returns HTML (from scripts_us_fetch.html)
        // Also multiply by 100 because the global formatPercent expects 0-100 range, not 0-1
        document.getElementById('metricTotalReturn').innerHTML = formatPercent((metrics.total_return ?? 0) * 100);
        document.getElementById('metricCAGR').innerHTML = formatPercent((metrics.cagr ?? 0) * 100);
        document.getElementById('metricSharpe').innerHTML = formatNumber(metrics.sharpe ?? 0); // formatNumber is also global but likely compatible
        document.getElementById('metricMaxDD').innerHTML = formatPercent((metrics.max_drawdown ?? 0) * 100);
        document.getElementById('metricVolatility').innerHTML = formatPercent((metrics.volatility ?? 0) * 100);

        if (data.equity_curve && data.equity_curve.length > 0) {
            const labels = data.equity_curve.map(p => p.date);
            const values = data.equity_curve.map(p => toFiniteNumber(p.equity));

            if (equityChart) {
                equityChart.destroy();
            }

            equityChart = new Chart(document.getElementById('equityChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Equity Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        const tradesTable = document.getElementById('tradesTable');
        if (data.trades && data.trades.length > 0) {
            tradesTable.innerHTML = data.trades.map(trade => {
                const displayDate = trade.trade_date || '-';
                const sideLabel = (trade.side || 'unknown').toUpperCase();
                return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${displayDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${trade.ticker || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${sideLabel === 'BUY' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${sideLabel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatNumber(trade.shares)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(trade.price)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$${formatNumber(trade.fee)}</td>
                </tr>
            `;
            }).join('');
        } else {
            tradesTable.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No trades</td></tr>';
        }
    }

    function startBacktest(data) {
        fetch('/api/backtest/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (!result || !result.run_id) {
                throw new Error((result && (result.error || result.message)) || 'Failed to start backtest');
            }
            selectRun(result.run_id);
            loadRuns();
        }).catch(err => {
            alert('Error starting backtest: ' + err);
        });
    }

    document.getElementById('backtestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        startBacktest(data);
    });

    loadRuns();
</script>
{% endblock %}